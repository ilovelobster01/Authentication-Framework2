{% extends 'layout.html' %}
{% block title %}Downloader{% endblock %}
{% block content %}
<h1>Downloader</h1>
<p class="muted">Paste a URL, analyze formats, then choose a combined (single file) format or separate video+audio. Combined works best with ffmpeg installed.</p>
<div class="panel">
  <h2>New download</h2>
  <p>
    <label>URL<br><input type="text" id="dl-url" size="80"></label>
    <button id="btn-analyze">Analyze</button>
  </p>
  <div>
    <strong>Cookies:</strong> {% if have_cookies %}<span class="flash success">Loaded</span>{% else %}<span class="flash error">None</span>{% endif %}
    <form id="cookies-form" enctype="multipart/form-data" method="post" action="{{ url_for('upload_cookies') }}" class="inline">
      <input type="file" name="cookies" accept=".txt" />
      <button type="submit">Upload cookies.txt</button>
    </form>
  </div>
  <div id="analyze-result" class="hidden">
    {% if not have_ffmpeg %}
      <div class="flash error">ffmpeg not detected on server. Merging video+audio may fail. Choose video-only or audio-only, or install ffmpeg.</div>
    {% endif %}
    <p>Title: <span id="dl-title"></span></p>
    <p>
      Mode:
      <label><input type="radio" name="mode" value="both" checked> Video + Audio (requires ffmpeg)</label>
      <label><input type="radio" name="mode" value="video"> Video only</label>
      <label><input type="radio" name="mode" value="audio"> Audio only</label>
      <label style="margin-left:1rem;"><input type="checkbox" id="show-raw"> Show raw formats</label>
    </p>
    <div id="raw-formats" class="hidden">
      <pre id="raw-pre" class="pre-wrap-40"></pre>
    </div>
    <p id="combined-row" class="hidden">
      Combined (single file): <select id="combined-format"></select>
    </p>
    <p id="separate-row">
      Video format: <select id="video-format"></select>
      Audio format: <select id="audio-format"></select>
    </p>
    <p>
      File name (optional, without extension): <input type="text" id="dl-filename" size="40">
      <button id="btn-enqueue">Enqueue Download</button>
    </p>
  </div>
</div>

<h2>Current task</h2>
{% if last_item %}
<table>
  <tr><th>When</th><th>Title</th><th>Status</th><th>File</th><th>Error</th></tr>
  <tr>
    <td>{{ last_item.created_at }}</td>
    <td>{{ last_item.title }}</td>
    <td>{{ last_item.status }}</td>
    <td>{% if last_item.filepath %}<a href="{{ url_for('download_file', download_id=last_item.id) }}">{{ last_item.filename }}</a>{% endif %}</td>
    <td>{% if last_item.error %}<pre class="pre-wrap-40">{{ last_item.error }}</pre>{% endif %}</td>
  </tr>
</table>
{% else %}
<p>No tasks yet.</p>
{% endif %}

<script src="{{ url_for('static', filename='js/downloads.js') }}"></script>
{% endblock %}
