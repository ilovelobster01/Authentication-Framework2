{% extends "base_new.html" %}

{% block title %}Search History - {{ config.APP_NAME }}{% endblock %}

{% block content %}
<div class="mb-4">
    <h2><i class="bi bi-search"></i> Search History</h2>
</div>

<!-- Search Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ search_stats.total if search_stats else 0 }}</h4>
                        <p class="mb-0">Total Searches</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-search fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ search_stats.completed if search_stats else 0 }}</h4>
                        <p class="mb-0">Completed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ search_stats.running if search_stats else 0 }}</h4>
                        <p class="mb-0">Running</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock-history fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ search_stats.failed if search_stats else 0 }}</h4>
                        <p class="mb-0">Failed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-x-circle fs-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Filters and Controls -->
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Search History</h5>
            </div>
            <div class="col-auto">
                <form method="GET" class="d-flex gap-2 flex-wrap" id="searchFilters">
                    <select name="tool" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">All Tools</option>
                        <option value="sherlock" {% if tool_filter == 'sherlock' %}selected{% endif %}>Sherlock</option>
                        <option value="holehe" {% if tool_filter == 'holehe' %}selected{% endif %}>Holehe</option>
                        <option value="instaloader" {% if tool_filter == 'instaloader' %}selected{% endif %}>InstaLoader</option>
                        <option value="telegram" {% if tool_filter == 'telegram' %}selected{% endif %}>Telegram</option>
                    </select>
                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">All Status</option>
                        <option value="PENDING" {% if status_filter == 'PENDING' %}selected{% endif %}>Pending</option>
                        <option value="RUNNING" {% if status_filter == 'RUNNING' %}selected{% endif %}>Running</option>
                        <option value="COMPLETED" {% if status_filter == 'COMPLETED' %}selected{% endif %}>Completed</option>
                        <option value="FAILED" {% if status_filter == 'FAILED' %}selected{% endif %}>Failed</option>
                        <option value="CANCELLED" {% if status_filter == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                    </select>
                    <select name="investigation" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">All Investigations</option>
                        {% for investigation in investigations %}
                        <option value="{{ investigation.id }}" {% if investigation_filter == investigation.id %}selected{% endif %}>
                            {{ investigation.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <select name="date_range" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="7" {% if date_range == '7' %}selected{% endif %}>Last 7 days</option>
                        <option value="30" {% if date_range == '30' %}selected{% endif %}>Last 30 days</option>
                        <option value="90" {% if date_range == '90' %}selected{% endif %}>Last 90 days</option>
                        <option value="" {% if not date_range %}selected{% endif %}>All time</option>
                    </select>
                    <input type="text" name="q" class="form-control form-control-sm" placeholder="Search query..." value="{{ search_query }}" onkeypress="if(event.key==='Enter') this.form.submit()">
                    <a href="{{ url_for('searches.index') }}" class="btn btn-outline-danger btn-sm" title="Clear all filters">
                        <i class="bi bi-x-lg"></i> Clear
                    </a>
                </form>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if searches.items %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Tool</th>
                        <th>Query</th>
                        <th>Investigation</th>
                        <th>Status</th>
                        <th>Results</th>
                        <th>Tor/IP</th>
                        <th>Duration</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for search in searches.items %}
                    <tr>
                        <td>
                            <input type="checkbox" name="search_ids" value="{{ search.id }}" class="search-checkbox">
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ search.tool_name.title() }}</span>
                        </td>
                        <td>
                            <a href="{{ url_for('searches.view', id=search.id) }}" class="text-decoration-none">
                                {{ search.search_query[:50] }}{% if search.search_query|length > 50 %}...{% endif %}
                            </a>
                        </td>
                        <td>
                            {% if search.investigation %}
                            <a href="{{ url_for('investigations.view', id=search.investigation.id) }}" class="text-decoration-none">
                                {{ search.investigation.name }}
                            </a>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if search.status.value == 'COMPLETED' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif search.status.value == 'RUNNING' %}
                            <span class="badge bg-warning">Running</span>
                            {% elif search.status.value == 'FAILED' %}
                            <span class="badge bg-danger">Failed</span>
                            {% elif search.status.value == 'CANCELLED' %}
                            <span class="badge bg-secondary">Cancelled</span>
                            {% else %}
                            <span class="badge bg-info">{{ search.status.value.title() }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if search.results_count %}
                            <span class="badge bg-info">{{ search.results_count }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if search.tor_used %}
                            <span class="badge bg-dark" title="Used Tor proxy">
                                <i class="bi bi-shield-lock"></i> Tor
                            </span>
                            {% else %}
                            <span class="badge bg-warning" title="Direct connection">
                                <i class="bi bi-globe"></i> Direct
                            </span>
                            {% endif %}
                            {% if search.ip_address %}
                            <small class="text-muted d-block" style="font-size: 0.7em;" title="IP Address">{{ search.ip_address }}</small>
                            {% endif %}
                            {% if search.tor_circuit_id %}
                            <small class="text-muted d-block" style="font-size: 0.7em;" title="Circuit ID">Circuit: {{ search.tor_circuit_id }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if search.duration_seconds %}
                            {% set mins = (search.duration_seconds // 60)|int %}
                            {% set secs = (search.duration_seconds % 60)|int %}
                            {% if mins > 0 %}{{ mins }}m {% endif %}{{ secs }}s
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ search.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('searches.view', id=search.id) }}" class="btn btn-outline-primary" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if search.results %}
                                <a href="{{ url_for('searches.view_results', id=search.id) }}" class="btn btn-outline-info" title="View Results">
                                    <i class="bi bi-list-ul"></i>
                                </a>
                                {% endif %}
                                {% if search.status.value in ['FAILED', 'CANCELLED'] %}
                                <form method="POST" action="{{ url_for('searches.retry', id=search.id) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-outline-warning btn-sm" title="Retry">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </form>
                                {% elif search.status.value == 'RUNNING' %}
                                <form method="POST" action="{{ url_for('searches.cancel', id=search.id) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Cancel">
                                        <i class="bi bi-stop-circle"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Bulk Actions -->
        <div class="card-footer">
            <div class="row align-items-center">
                <div class="col">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="bulkDelete()" disabled id="bulk-delete-btn">
                            <i class="bi bi-trash"></i> Delete Selected
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="bulkReport()" disabled id="bulk-report-btn">
                            <i class="bi bi-file-earmark-pdf"></i> Generate Report
                        </button>
                    </div>
                </div>
                <div class="col-auto">
                    <span id="selected-count" class="text-muted">0 selected</span>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if searches.pages > 1 %}
        <div class="card-footer">
            <nav aria-label="Search pagination">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% set args_without_page = request.args.copy() %}
                    {% if args_without_page.pop('page', None) %}{% endif %}
                    
                    {% if searches.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('searches.index', page=searches.prev_num, **args_without_page) }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in searches.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != searches.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('searches.index', page=page_num, **args_without_page) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if searches.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('searches.index', page=searches.next_num, **args_without_page) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-search fs-1 text-muted"></i>
            <h5 class="mt-3">No Searches Found</h5>
            <p class="text-muted">No search history available.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Links -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Analytics</h6>
            </div>
            <div class="card-body">
                <p class="text-muted">View detailed search analytics and performance metrics.</p>
                <a href="{{ url_for('searches.analytics') }}" class="btn btn-outline-primary">
                    View Analytics
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-files"></i> Duplicates</h6>
            </div>
            <div class="card-body">
                <p class="text-muted">Find and manage duplicate searches to optimize your investigations.</p>
                <a href="{{ url_for('searches.duplicate_check') }}" class="btn btn-outline-secondary">
                    Check Duplicates
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Checkbox selection management
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const searchCheckboxes = document.querySelectorAll('.search-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const bulkReportBtn = document.getElementById('bulk-report-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    
    function updateBulkButtons() {
        const selectedCheckboxes = document.querySelectorAll('.search-checkbox:checked');
        const count = selectedCheckboxes.length;
        
        bulkDeleteBtn.disabled = count === 0;
        bulkReportBtn.disabled = count === 0;
        selectedCountSpan.textContent = count + ' selected';
        
        // Update select all checkbox state
        if (count === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (count === searchCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
            selectAllCheckbox.checked = false;
        }
    }
    
    // Select all functionality
    selectAllCheckbox.addEventListener('change', function() {
        searchCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkButtons();
    });
    
    // Individual checkbox change
    searchCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkButtons);
    });
    
    // Initial state
    updateBulkButtons();
});

function bulkDelete() {
    const selectedCheckboxes = document.querySelectorAll('.search-checkbox:checked');
    if (selectedCheckboxes.length === 0) return;
    
    if (confirm(`Are you sure you want to delete ${selectedCheckboxes.length} selected searches? This action cannot be undone.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("searches.bulk_delete") }}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }
        
        selectedCheckboxes.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'search_ids';
            input.value = checkbox.value;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

function bulkReport() {
    const selectedCheckboxes = document.querySelectorAll('.search-checkbox:checked');
    if (selectedCheckboxes.length === 0) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("searches.bulk_report") }}';
    
    // Add CSRF token
    const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
    }
    
    selectedCheckboxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'search_ids';
        input.value = checkbox.value;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}