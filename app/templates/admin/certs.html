{% extends 'layout.html' %}
{% block title %}Certificate Management{% endblock %}
{% block content %}
<h1>Certificate Management</h1>

<h2>Issue new client certificate</h2>
<form method="post" action="{{ url_for('admin.issue_cert') }}">
  {{ issue_form.hidden_tag() }}
  <p>
    {{ issue_form.username.label }}<br>
    {{ issue_form.username(size=32) }}
  </p>
  <p>
    {{ issue_form.email.label }}<br>
    {{ issue_form.email(size=48) }}
  </p>
  <p>
    {{ issue_form.p12_password.label }}<br>
    {{ issue_form.p12_password(size=32) }}
  </p>
  <p>
    {{ issue_form.ca_password.label }}<br>
    {{ issue_form.ca_password(size=32) }}
  </p>
  <p>{{ issue_form.submit() }}</p>
</form>

{% if issued %}
  <h3>Issued for {{ issued.username }}</h3>
  <ul>
    <li>Download: <a href="{{ url_for('admin.download_cert', username=issued.username, kind='p12') }}">{{ issued.username }}.p12</a></li>
    <li>CRT: <a href="{{ url_for('admin.download_cert', username=issued.username, kind='crt') }}">{{ issued.username }}.crt</a></li>
  </ul>
{% endif %}

<h2>All certificates</h2>
<form method="get" action="{{ url_for('admin.certs_index') }}">
  {{ filter_form.hidden_tag() }}
  <label>Username {{ filter_form.username(size=24) }}</label>
  <label>Fingerprint {{ filter_form.fingerprint(size=24) }}</label>
  <label>Status {{ filter_form.status() }}</label>
  <label>Validity {{ filter_form.validity() }}</label>
  <button type="submit">Apply</button>
</form>

<p>
  <a href="{{ export_url }}">Export CSV</a>
</p>

<table>
  <tr><th>User</th><th>Fingerprint</th><th>Subject</th><th>Issuer</th><th>Serial</th><th>Valid</th><th>Status</th><th>Actions</th></tr>
  {% for c in certs %}
    <tr>
      <td><a href="{{ url_for('admin.user_detail', user_id=c.user_id) }}">{{ c.user.username }}</a></td>
      <td><code>{{ c.fingerprint_sha256 }}</code></td>
      <td>{{ c.subject }}</td>
      <td>{{ c.issuer }}</td>
      <td>{{ c.serial_number }}</td>
      <td>{{ c.not_before }} - {{ c.not_after }}</td>
      <td>{{ 'Revoked' if c.is_revoked else 'Active' }}</td>
      <td>
        <a href="{{ url_for('admin.cert_view', fingerprint=c.fingerprint_sha256) }}">View</a>
        {% if c.is_revoked %}
          <form method="post" action="{{ url_for('admin.unrevoke_cert') }}" class="inline">
            <input type="hidden" name="fingerprint" value="{{ c.fingerprint_sha256 }}" />
            <button type="submit">Unrevoke</button>
          </form>
        {% else %}
          <form method="post" action="{{ url_for('admin.revoke_cert_global') }}" class="inline">
            <input type="hidden" name="fingerprint" value="{{ c.fingerprint_sha256 }}" />
            <button type="submit">Revoke</button>
          </form>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
</table>

<div class="pagination">
  {% if prev_url %}
    <a href="{{ prev_url }}">&laquo; Prev</a>
  {% endif %}
  <span>Page {{ page }} of {{ last_page }} ({{ total }} total)</span>
  {% if next_url %}
    <a href="{{ next_url }}">Next &raquo;</a>
  {% endif %}
</div>

{% endblock %}
