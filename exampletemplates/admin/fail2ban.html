{% extends "base_new.html" %}

{% block title %}Fail2Ban Management - Admin{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('admin.index') }}">
                <i class="bi bi-house-door"></i> Admin Dashboard
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-shield-exclamation"></i> Fail2Ban Security
        </li>
    </ol>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-shield-exclamation text-danger"></i> Fail2Ban Security Management</h2>
                    <p class="text-muted mb-0">Monitor and manage automated IP blocking for brute force protection</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('admin.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Admin
                    </a>
                    <button id="refresh-btn" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-info-circle"></i> Fail2Ban Status</h5>
                </div>
                <div class="card-body">
                    <pre id="fail2ban-status" class="bg-light p-3" style="max-height: 200px; overflow-y: auto;">Loading...</pre>
                </div>
            </div>

            <!-- Banned IPs Card -->
            <div class="card">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-slash-circle"></i> Banned IP Addresses</h5>
                    <span id="banned-count" class="badge bg-light text-dark">0</span>
                </div>
                <div class="card-body">
                    <div id="banned-ips-container">
                        <div class="text-center p-4">
                            <div class="spinner-border text-muted" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading banned IPs...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Unban -->
            <div class="card mt-4">
                <div class="card-header bg-warning">
                    <h5><i class="bi bi-exclamation-triangle"></i> Emergency Unban</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Manually unban an IP address from all jails:</p>
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" id="manual-unban-ip" class="form-control" 
                                   placeholder="Enter IP address (e.g., 192.168.1.100)" 
                                   pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                        </div>
                        <div class="col-md-4">
                            <button id="manual-unban-btn" class="btn btn-warning w-100">
                                <i class="bi bi-unlock"></i> Emergency Unban
                            </button>
                        </div>
                    </div>
                    <small class="text-info mt-2 d-block">
                        <i class="bi bi-shield-check"></i> 
                        192.168.10.x addresses are automatically whitelisted and should never be banned.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let bannedIpsData = {};

    function loadStatus() {
        fetch('/admin/api/fail2ban/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('fail2ban-status').textContent = data.data;
                } else {
                    document.getElementById('fail2ban-status').textContent = 'Error loading status: ' + data.message;
                }
            })
            .catch(error => {
                document.getElementById('fail2ban-status').textContent = 'Error: ' + error.message;
            });
    }

    function loadBannedIPs() {
        fetch('/admin/api/fail2ban/banned')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    bannedIpsData = data.banned_ips;
                    displayBannedIPs(bannedIpsData);
                    document.getElementById('banned-count').textContent = data.total_banned;
                } else {
                    document.getElementById('banned-ips-container').innerHTML = 
                        '<div class="alert alert-danger">Error loading banned IPs: ' + data.message + '</div>';
                }
            })
            .catch(error => {
                document.getElementById('banned-ips-container').innerHTML = 
                    '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
    }

    function displayBannedIPs(bannedIps) {
        const container = document.getElementById('banned-ips-container');
        
        if (Object.keys(bannedIps).length === 0) {
            container.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> No banned IPs found! System is clean.</div>';
            return;
        }

        let html = '';
        for (const [jail, ips] of Object.entries(bannedIps)) {
            html += `<div class="mb-4">
                        <h6 class="text-primary border-bottom pb-1"><i class="bi bi-lock"></i> ${jail}</h6>
                        <div class="row">`;
            
            ips.forEach(ipData => {
                const ip = typeof ipData === 'string' ? ipData : ipData.ip;
                const isWhitelisted = typeof ipData === 'object' && ipData.whitelisted;
                const badgeClass = isWhitelisted ? 'badge-warning' : 'badge-danger';
                const whitelistIcon = isWhitelisted ? '<i class="bi bi-exclamation-triangle"></i> ' : '<i class="bi bi-slash-circle"></i> ';
                const whitelistText = isWhitelisted ? ' (WHITELISTED!)' : '';
                
                html += `<div class="col-md-6 col-lg-4 mb-2">
                            <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded border">
                                <span class="badge ${badgeClass} me-2">${whitelistIcon}${ip}${whitelistText}</span>
                                <button class="btn btn-sm btn-outline-success unban-btn" data-ip="${ip}" data-jail="${jail}">
                                    <i class="bi bi-unlock"></i> Unban
                                </button>
                            </div>
                         </div>`;
            });
            
            html += '</div></div>';
        }
        
        container.innerHTML = html;
        
        // Add unban event listeners
        document.querySelectorAll('.unban-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const ip = this.dataset.ip;
                unbanIP(ip, this);
            });
        });
    }

    function unbanIP(ip, button) {
        const originalContent = button.innerHTML;
        button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';
        button.disabled = true;

        fetch('/admin/api/fail2ban/unban', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            },
            body: JSON.stringify({ip: ip})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' || data.status === 'warning') {
                showAlert(data.message, data.status === 'success' ? 'success' : 'warning');
                setTimeout(loadBannedIPs, 1500); // Refresh after 1.5 seconds
            } else {
                showAlert('Error unbanning IP: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Network error: ' + error.message, 'danger');
        })
        .finally(() => {
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }

    function showAlert(message, type) {
        // Remove existing alerts
        document.querySelectorAll('.dynamic-alert').forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show dynamic-alert`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.maxWidth = '400px';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" onclick="this.parentElement.remove()">
                <span>&times;</span>
            </button>
        `;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'bi bi-arrow-clockwise';
        icon.style.animation = 'spin 1s linear infinite';
        
        loadStatus();
        loadBannedIPs();
        
        setTimeout(() => {
            icon.className = originalClass;
            icon.style.animation = '';
        }, 1000);
    });

    document.getElementById('manual-unban-btn').addEventListener('click', function() {
        const ip = document.getElementById('manual-unban-ip').value.trim();
        if (!ip) {
            showAlert('Please enter an IP address', 'warning');
            return;
        }
        
        // Simple IP validation
        const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
        if (!ipRegex.test(ip)) {
            showAlert('Please enter a valid IP address', 'warning');
            return;
        }
        
        unbanIP(ip, this);
        document.getElementById('manual-unban-ip').value = '';
    });

    // Enter key for manual unban
    document.getElementById('manual-unban-ip').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('manual-unban-btn').click();
        }
    });

    // Initial load
    loadStatus();
    loadBannedIPs();
    
    // Auto-refresh every 60 seconds
    setInterval(() => {
        loadBannedIPs();
    }, 60000);
});
</script>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}