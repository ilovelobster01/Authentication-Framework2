{% extends "base_new.html" %}

{% block title %}User Management - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-people"></i> User Management</h3>
    <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">
        <i class="bi bi-person-plus"></i> Create User
    </a>
</div>

<!-- Search and Filter Form -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="q" class="form-label">Search Users</label>
                <input type="text" class="form-control" id="q" name="q" value="{{ search_query }}" 
                       placeholder="Username, email, or name">
            </div>
            <div class="col-md-3">
                <label for="role" class="form-label">Role</label>
                <select class="form-select" id="role" name="role">
                    <option value="">All Roles</option>
                    {% for role in roles %}
                    <option value="{{ role.name }}" {% if role_filter == role.name %}selected{% endif %}>
                        {{ role.name.title() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Status</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Actions -->
<form id="bulkForm" method="POST" action="{{ url_for('admin.bulk_user_actions') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <select name="action" class="form-select" required>
                            <option value="">Select Action</option>
                            <option value="activate">Activate Selected</option>
                            <option value="deactivate">Deactivate Selected</option>
                            <option value="change_role">Change Role</option>
                            <option value="delete">Delete Selected</option>
                        </select>
                        <select name="new_role" class="form-select" style="display:none;">
                            {% for role in roles %}
                            <option value="{{ role.name }}">{{ role.name.title() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <button type="submit" class="btn btn-primary" onclick="return confirmBulkAction()">
                        <i class="bi bi-gear"></i> Execute Action
                    </button>
                    <span class="text-muted ms-2" id="selectedCount">0 users selected</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="30">
                                <input type="checkbox" id="selectAll" class="form-check-input">
                            </th>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th width="120">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users.items %}
                        <tr>
                            <td>
                                <input type="checkbox" name="user_ids" value="{{ user.id }}" 
                                       class="form-check-input user-checkbox" 
                                       {% if user.id == current_user.id %}disabled{% endif %}>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        {% if user.is_admin %}
                                            <i class="bi bi-shield-check text-warning" title="Admin"></i>
                                        {% else %}
                                            <i class="bi bi-person-circle text-muted"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ user.username }}</div>
                                        {% if user.full_name != user.username %}
                                            <small class="text-muted">{{ user.full_name }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% for role in user.roles %}
                                    <span class="badge bg-secondary">{{ role.name.title() }}</span>
                                {% endfor %}
                            </td>
                            <td>
                                {% if user.active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                                {% if not user.confirmed_at %}
                                    <span class="badge bg-warning">Unconfirmed</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ user.created_at.strftime('%Y-%m-%d') }}</small>
                            </td>
                            <td>
                                {% if user.last_login_at %}
                                    <small>{{ user.last_login_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                {% else %}
                                    <small class="text-muted">Never</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" 
                                       class="btn btn-outline-primary" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" 
                                       class="btn btn-outline-secondary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{{ url_for('admin.user_permissions', user_id=user.id) }}" 
                                       class="btn btn-outline-info" title="Permissions">
                                        <i class="bi bi-gear"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if users.pages > 1 %}
        <div class="card-footer">
            <nav aria-label="User pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if users.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.users', page=users.prev_num, q=search_query, role=role_filter, status=status_filter) }}">Previous</a>
                        </li>
                    {% endif %}
                    
                    {% for page_num in users.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != users.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.users', page=page_num, q=search_query, role=role_filter, status=status_filter) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if users.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.users', page=users.next_num, q=search_query, role=role_filter, status=status_filter) }}">Next</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</form>

<!-- Summary Info -->
<div class="row mt-4">
    <div class="col-md-12">
        <small class="text-muted">
            Showing {{ users.total }} user{{ 's' if users.total != 1 else '' }}
            {% if search_query or role_filter or status_filter %}
                (filtered)
            {% endif %}
        </small>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Select All functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox:not(:disabled)');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateSelectedCount();
});

// Update selected count
function updateSelectedCount() {
    const selected = document.querySelectorAll('.user-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selected + ' user' + (selected !== 1 ? 's' : '') + ' selected';
}

// Listen for checkbox changes
document.querySelectorAll('.user-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

// Show role selector when "Change Role" is selected
document.querySelector('select[name="action"]').addEventListener('change', function() {
    const roleSelector = document.querySelector('select[name="new_role"]');
    if (this.value === 'change_role') {
        roleSelector.style.display = 'block';
        roleSelector.required = true;
    } else {
        roleSelector.style.display = 'none';
        roleSelector.required = false;
    }
});

// Confirm bulk actions
function confirmBulkAction() {
    const action = document.querySelector('select[name="action"]').value;
    const selected = document.querySelectorAll('.user-checkbox:checked').length;
    
    if (selected === 0) {
        alert('Please select at least one user');
        return false;
    }
    
    let message = '';
    if (action === 'delete') {
        message = 'Are you sure you want to delete ' + selected + ' user(s)? This action cannot be undone.';
        // Add hidden confirmation field for bulk delete
        const form = document.getElementById('bulkForm');
        const confirmInput = document.createElement('input');
        confirmInput.type = 'hidden';
        confirmInput.name = 'confirm_bulk_delete';
        confirmInput.value = 'true';
        form.appendChild(confirmInput);
    } else {
        message = 'Are you sure you want to ' + action + ' ' + selected + ' user(s)?';
    }
    
    return confirm(message);
}

// Initialize count
updateSelectedCount();
</script>
{% endblock %}