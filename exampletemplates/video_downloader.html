{% extends "base_new.html" %}

{% block title %}Video Downloader - {{ config.APP_NAME }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-cloud-download"></i> Video Downloader</h2>
        <p class="text-muted mb-0">Download videos from YouTube, Vimeo, TikTok, and 1000+ other platforms</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-outline-info" onclick="showStorageStatus()">
            <i class="bi bi-hdd"></i> Storage Status
        </button>
        <button class="btn btn-outline-primary" onclick="showDownloadHistory()">
            <i class="bi bi-clock-history"></i> My Downloads
        </button>
    </div>
</div>

<!-- Quota Status Alert -->
<div id="quotaAlert" class="alert alert-info">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-speedometer2"></i>
            <strong>Download Quota:</strong>
            <span id="quotaStatus">Loading...</span>
        </div>
        <button type="button" class="btn-close" onclick="hideQuotaAlert()"></button>
    </div>
</div>

<!-- Video Analysis Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-search"></i> Analyze Video</h5>
    </div>
    <div class="card-body">
        <form id="analyzeForm">
            <div class="mb-3">
                <label for="videoUrl" class="form-label">Video URL</label>
                <input type="url" class="form-control" id="videoUrl" name="url" required 
                       placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                <div class="form-text">Enter URL from YouTube, Vimeo, TikTok, Instagram, Twitter, or 1000+ other platforms</div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> Analyze Video
            </button>
        </form>
    </div>
</div>

<!-- Analysis Results -->
<div id="analysisResults" class="card mb-4" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Video Information</h5>
    </div>
    <div class="card-body">
        <div id="videoMetadata"></div>
        
        <!-- Download Form -->
        <div class="mt-4">
            <h6><i class="bi bi-download"></i> Download Options</h6>
            <form id="downloadForm">
                <input type="hidden" id="downloadUrl" name="url">
                <div class="row">
                    <div class="col-md-6">
                        <label for="quality" class="form-label">Quality</label>
                        <select class="form-select" id="quality" name="quality">
                            <option value="best">Best Quality (up to 1080p)</option>
                            <option value="720p">720p HD</option>
                            <option value="480p">480p SD</option>
                            <option value="360p">360p</option>
                            <option value="audio">Audio Only</option>
                            <option value="worst">Lowest Quality</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="formatSelect" class="form-label">Specific Format (Optional)</label>
                        <select class="form-select" id="formatSelect" name="format_id">
                            <option value="">Auto-select best format</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <label for="customFilename" class="form-label">Custom Filename (Optional)</label>
                    <input type="text" class="form-control" id="customFilename" name="custom_filename"
                           placeholder="Leave empty to use video title">
                    <div class="form-text">Will be sanitized automatically. Extension will be added based on format.</div>
                </div>
                <div class="mt-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="useTorProxy" name="use_tor">
                        <label class="form-check-label" for="useTorProxy">
                            <i class="bi bi-shield-lock"></i> Use TOR Proxy
                        </label>
                        <div class="form-text">Download through TOR for enhanced privacy and anonymity.</div>
                        <div id="torStatus" class="mt-2"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <label for="investigationSelect" class="form-label">Investigation (Optional)</label>
                    <select class="form-select" id="investigationSelect" name="investigation_id">
                        <option value="">No investigation</option>
                        <!-- Investigation options will be loaded dynamically -->
                    </select>
                    <div class="form-text">Link this download to an investigation for better organization.</div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success" id="downloadBtn">
                        <i class="bi bi-download"></i> Queue Download
                    </button>
                    <small class="text-muted d-block mt-1" id="quotaInfo"></small>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Download Progress -->
<div id="downloadProgress" class="card mb-4" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Download in Progress</h5>
    </div>
    <div class="card-body">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div>
                <div><strong>Downloading:</strong> <span id="downloadingTitle"></span></div>
                <div class="text-muted">This may take a few minutes depending on video size...</div>
            </div>
        </div>
        <div class="mt-3">
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 100%"></div>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-outline-danger btn-sm" onclick="cancelCurrentDownload()">
                <i class="bi bi-x-circle"></i> Cancel Download
            </button>
        </div>
    </div>
</div>

<!-- Download Complete -->
<div id="downloadComplete" class="card mb-4" style="display: none;">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-check-circle"></i> Download Complete</h5>
    </div>
    <div class="card-body">
        <div id="downloadResult"></div>
    </div>
</div>

<!-- Analyze Next Video (shows when downloads are active) -->
<div id="analyzeNext" class="card mb-4" style="display: none;">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Analyze Next Video</h5>
    </div>
    <div class="card-body">
        <p class="mb-3">You have active downloads running. You can analyze another video while waiting!</p>
        <form id="analyzeNextForm">
            <div class="input-group">
                <input type="url" class="form-control" id="nextVideoUrl" name="url" 
                       placeholder="Enter another video URL to analyze">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-search"></i> Analyze
                </button>
            </div>
        </form>
    </div>
</div>

<!-- My Downloads Section -->
<div id="downloadsHistory" class="card" style="display: none;">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> My Downloads</h5>
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshDownloadHistory()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="downloadsContent">Loading...</div>
    </div>
</div>

<!-- Error Messages -->
<div id="errorAlert" class="alert alert-danger" style="display: none;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Error:</strong> <span id="errorMessage"></span>
        </div>
        <button type="button" class="btn-close" onclick="hideError()"></button>
    </div>
</div>

<script>
let currentDownloadId = null;
let downloadCheckInterval = null;
let activeDownloads = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadQuotaStatus();
    loadInvestigations();
    checkActiveDownloads();
    loadTorStatus();
    
    // Set up form handlers
    document.getElementById('analyzeForm').addEventListener('submit', analyzeVideo);
    document.getElementById('downloadForm').addEventListener('submit', downloadVideo);
    document.getElementById('analyzeNextForm').addEventListener('submit', analyzeNextVideo);
});

function analyzeVideo(event) {
    event.preventDefault();
    
    const url = document.getElementById('videoUrl').value;
    if (!url) {
        showError('Please enter a video URL');
        return;
    }
    
    // Show loading state
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';
    submitBtn.disabled = true;
    
    hideError();
    document.getElementById('analysisResults').style.display = 'none';
    
    // Make API call to analyze video
    fetch('/api/video-downloader/analyze', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({ url: url })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAnalysisResults(data);
        } else {
            showError(data.error || 'Failed to analyze video');
        }
    })
    .catch(error => {
        console.error('Analysis error:', error);
        showError('Network error occurred while analyzing video');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function displayAnalysisResults(data) {
    const metadata = data.metadata;
    const formats = data.formats;
    
    // Display video metadata
    const metadataHtml = `
        <div class="row">
            <div class="col-md-8">
                <h6><strong>${escapeHtml(metadata.title)}</strong></h6>
                <p class="text-muted mb-1"><strong>Uploader:</strong> ${escapeHtml(metadata.uploader)}</p>
                <p class="text-muted mb-1"><strong>Duration:</strong> ${formatDuration(metadata.duration)}</p>
                <p class="text-muted mb-1"><strong>Upload Date:</strong> ${formatDate(metadata.upload_date)}</p>
                <p class="text-muted mb-1"><strong>Views:</strong> ${formatNumber(metadata.view_count)}</p>
                <p class="text-muted mb-1"><strong>Platform:</strong> ${escapeHtml(metadata.extractor)}</p>
                <p class="text-muted mb-1"><strong>Estimated Size:</strong> ${formatFileSize(metadata.filesize_approx)}</p>
            </div>
            <div class="col-md-4">
                ${metadata.thumbnail ? `<img src="${metadata.thumbnail}" class="img-fluid rounded" alt="Thumbnail">` : ''}
            </div>
        </div>
        ${metadata.description ? `<div class="mt-3"><strong>Description:</strong><div class="text-muted" style="max-height: 100px; overflow-y: auto;">${escapeHtml(metadata.description)}</div></div>` : ''}
    `;
    
    document.getElementById('videoMetadata').innerHTML = metadataHtml;
    
    // Populate format options
    const formatSelect = document.getElementById('formatSelect');
    formatSelect.innerHTML = '<option value="">Auto-select best format</option>';
    
    if (formats && formats.length > 0) {
        const formatGroups = {
            'Video + Audio': formats.filter(f => f.vcodec !== 'none' && f.acodec !== 'none'),
            'Video Only': formats.filter(f => f.vcodec !== 'none' && f.acodec === 'none'),
            'Audio Only': formats.filter(f => f.vcodec === 'none' && f.acodec !== 'none')
        };
        
        Object.entries(formatGroups).forEach(([groupName, groupFormats]) => {
            if (groupFormats.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = groupName;
                formatSelect.appendChild(optgroup);
                
                groupFormats.slice(0, 10).forEach(format => {
                    const option = document.createElement('option');
                    option.value = format.format_id;
                    option.textContent = `${format.resolution || 'Unknown'} - ${format.ext} (${formatFileSize(format.filesize || format.filesize_approx)})`;
                    optgroup.appendChild(option);
                });
            }
        });
    }
    
    // Set the download URL
    document.getElementById('downloadUrl').value = data.url;
    
    // Show the results
    document.getElementById('analysisResults').style.display = 'block';
    document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
}

function downloadVideo(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    // Show loading state
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Queuing Download...';
    submitBtn.disabled = true;
    
    hideError();
    const downloadCompleteElement = document.getElementById('downloadComplete');
    if (downloadCompleteElement) {
        downloadCompleteElement.style.display = 'none';
    }
    
    // Show progress
    const metadataElement = document.getElementById('videoMetadata');
    const titleElement = metadataElement ? metadataElement.querySelector('h6 strong') : null;
    const title = titleElement ? titleElement.textContent : 'Video';
    const downloadingTitleElement = document.getElementById('downloadingTitle');
    if (downloadingTitleElement) {
        downloadingTitleElement.textContent = title;
    }
    const downloadProgressElement = document.getElementById('downloadProgress');
    if (downloadProgressElement) {
        downloadProgressElement.style.display = 'block';
        downloadProgressElement.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Make API call to queue video download
    fetch('/api/video-downloader/download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentDownloadId = data.download_id;
            activeDownloads.push(data.download_id);
            
            // Update progress message
            const progressBodyDiv = document.querySelector('#downloadProgress .card-body div');
            if (progressBodyDiv) {
                progressBodyDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <div><strong>Queued:</strong> ${escapeHtml(data.title || title)}</div>
                            <div class="text-muted">Download queued successfully. ${escapeHtml(data.estimated_wait_time || 'Processing...')}</div>
                        </div>
                    </div>
                `;
            }
            
            // Start checking download status
            downloadCheckInterval = setInterval(checkDownloadStatus, 3000);
            
            // Show analyze next option
            showAnalyzeNext();
            
            // Update quota display
            loadQuotaStatus();
            
        } else {
            showError(data.error || 'Failed to queue download');
            document.getElementById('downloadProgress').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Download error:', error);
        showError('Network error occurred while queuing download');
        document.getElementById('downloadProgress').style.display = 'none';
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function checkDownloadStatus() {
    if (!currentDownloadId) return;
    
    fetch(`/api/video-downloader/status/${currentDownloadId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'completed') {
            clearInterval(downloadCheckInterval);
            showDownloadComplete(data);
        } else if (data.status === 'error' || data.status === 'expired') {
            clearInterval(downloadCheckInterval);
            showError(data.error || 'Download failed');
            document.getElementById('downloadProgress').style.display = 'none';
        }
        // Keep checking if status is still processing
    })
    .catch(error => {
        console.error('Status check error:', error);
        // Stop infinite loop on error
        clearInterval(downloadCheckInterval);
        showError(`Status check failed: ${error.message}`);
        document.getElementById('downloadProgress').style.display = 'none';
    });
}

function showDownloadComplete(data) {
    document.getElementById('downloadProgress').style.display = 'none';
    
    const resultHtml = `
        <div class="row">
            <div class="col-md-8">
                <h6><strong>Successfully Downloaded</strong></h6>
                <p class="mb-1"><strong>Filename:</strong> ${escapeHtml(data.filename)}</p>
                <p class="mb-1"><strong>File Size:</strong> ${formatFileSize(data.file_size)}</p>
                <p class="mb-1"><strong>Download ID:</strong> <code>${data.download_id}</code></p>
                <p class="mb-1"><strong>Expires:</strong> ${formatDate(data.expires_at)}</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/api/video-downloader/download-file/${data.download_id}" class="btn btn-primary mb-2" target="_blank">
                    <i class="bi bi-download"></i> Download File
                </a><br>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteDownload('${data.download_id}')">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
        <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle"></i>
            Files are automatically deleted after 7 days or when storage is full.
        </div>
    `;
    
    document.getElementById('downloadResult').innerHTML = resultHtml;
    document.getElementById('downloadComplete').style.display = 'block';
    document.getElementById('downloadComplete').scrollIntoView({ behavior: 'smooth' });
    
    // Refresh quota status
    loadQuotaStatus();
}

function showDownloadHistory() {
    document.getElementById('downloadsHistory').style.display = 'block';
    document.getElementById('downloadsHistory').scrollIntoView({ behavior: 'smooth' });
    refreshDownloadHistory();
}

function refreshDownloadHistory() {
    const downloadsContentElement = document.getElementById('downloadsContent');
    if (!downloadsContentElement) {
        console.error('downloadsContent element not found in refreshDownloadHistory');
        return;
    }
    
    downloadsContentElement.innerHTML = 'Loading...';
    
    fetch('/api/video-downloader/downloads')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayDownloadHistory(data.downloads);
        } else {
            downloadsContentElement.innerHTML = 
                '<div class="alert alert-warning">Failed to load download history</div>';
        }
    })
    .catch(error => {
        console.error('Error loading downloads:', error);
        downloadsContentElement.innerHTML = 
            '<div class="alert alert-danger">Error loading download history</div>';
    });
}

function displayDownloadHistory(downloads) {
    const downloadsContentElement = document.getElementById('downloadsContent');
    if (!downloadsContentElement) {
        console.error('downloadsContent element not found');
        return;
    }
    
    if (downloads.length === 0) {
        downloadsContentElement.innerHTML = 
            '<div class="text-muted text-center py-4">No downloads yet</div>';
        return;
    }
    
    const downloadsHtml = downloads.map(download => `
        <div class="border rounded p-3 mb-3">
            <div class="row">
                <div class="col-md-8">
                    <h6><strong>${escapeHtml(download.metadata ? download.metadata.title : download.title || 'Unknown Video')}</strong></h6>
                    <p class="text-muted mb-1"><strong>Filename:</strong> ${escapeHtml(download.filename || 'Unknown')}</p>
                    <p class="text-muted mb-1"><strong>Size:</strong> ${formatFileSize(download.file_size || 0)}</p>
                    <p class="text-muted mb-1"><strong>Downloaded:</strong> ${formatDate(download.downloaded_at || download.created_at)}</p>
                    <p class="text-muted mb-1"><strong>Expires:</strong> ${formatDate(download.expires_at)}</p>
                    <p class="text-muted mb-1"><strong>Status:</strong> 
                        <span class="badge ${download.exists ? 'bg-success' : 'bg-warning'}">
                            ${download.exists ? 'Available' : 'Expired'}
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    ${download.exists ? `
                        <a href="/api/video-downloader/download-file/${download.download_id}" 
                           class="btn btn-primary btn-sm mb-2" target="_blank">
                            <i class="bi bi-download"></i> Download
                        </a><br>
                    ` : ''}
                    ${['pending', 'analyzing', 'queued', 'downloading'].includes(download.status) ? `
                        <button class="btn btn-outline-warning btn-sm mb-2" 
                                onclick="cancelDownload('${download.download_id}')">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button><br>
                    ` : ''}
                    <button class="btn btn-outline-danger btn-sm" 
                            onclick="deleteDownload('${download.download_id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    
    downloadsContentElement.innerHTML = downloadsHtml;
}

function deleteDownload(downloadId) {
    if (!confirm('Are you sure you want to delete this download?')) {
        return;
    }
    
    console.log('Attempting to delete download:', downloadId);
    const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    console.log('CSRF token:', csrfToken);
    
    fetch(`/api/video-downloader/delete/${downloadId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || ''
        }
    })
    .then(response => {
        console.log('Delete response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Delete response data:', data);
        if (data.success) {
            refreshDownloadHistory();
            loadQuotaStatus();
            
            // Hide download complete if it's the current one
            if (currentDownloadId === downloadId) {
                document.getElementById('downloadComplete').style.display = 'none';
            }
            
            // Show success message
            showSuccess('Download deleted successfully');
        } else {
            showError(data.error || 'Failed to delete download');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        showError(`Error deleting download: ${error.message}`);
    });
}

function cancelDownload(downloadId) {
    if (!confirm('Are you sure you want to cancel this download?')) {
        return;
    }
    
    console.log('Attempting to cancel download:', downloadId);
    const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    
    fetch(`/api/video-downloader/cancel/${downloadId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || ''
        }
    })
    .then(response => {
        console.log('Cancel response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Cancel response data:', data);
        if (data.success) {
            refreshDownloadHistory();
            showSuccess('Download cancelled successfully');
            
            // Hide progress if it's the current download
            if (currentDownloadId === downloadId) {
                document.getElementById('downloadProgress').style.display = 'none';
                currentDownloadId = null;
                if (downloadCheckInterval) {
                    clearInterval(downloadCheckInterval);
                    downloadCheckInterval = null;
                }
            }
        } else {
            showError(data.error || 'Failed to cancel download');
        }
    })
    .catch(error => {
        console.error('Cancel error:', error);
        showError(`Error cancelling download: ${error.message}`);
    });
}

function cancelCurrentDownload() {
    if (currentDownloadId) {
        cancelDownload(currentDownloadId);
    }
}

function showStorageStatus() {
    // Show quota alert which includes storage information
    loadQuotaStatus();
    document.getElementById('quotaAlert').style.display = 'block';
}

function hideQuotaAlert() {
    document.getElementById('quotaAlert').style.display = 'none';
}

function loadQuotaStatus() {
    // This will be loaded via the API to get user's current quota
    fetch('/api/downloads/quota-status')
    .then(response => response.json())
    .then(data => {
        if (data.daily_remaining !== undefined) {
            const quotaText = `${data.daily_downloads_used}/${data.max_daily_downloads} daily downloads used, ${data.storage_used_mb}/${data.max_storage_mb}MB storage`;
            document.getElementById('quotaStatus').textContent = quotaText;
            document.getElementById('quotaInfo').textContent = `${data.daily_remaining} downloads remaining today`;
            
            // Update download button state
            const downloadBtn = document.getElementById('downloadBtn');
            if (data.daily_remaining <= 0) {
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<i class="bi bi-x-circle"></i> Daily Limit Reached';
            } else if (data.storage_remaining_mb <= 0) {
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<i class="bi bi-hdd"></i> Storage Full';
            }
            
            // Update alert class based on usage
            const alertDiv = document.getElementById('quotaAlert');
            alertDiv.className = 'alert';
            if (data.daily_remaining <= 0 || data.storage_remaining_mb <= 0) {
                alertDiv.classList.add('alert-danger');
            } else if (data.daily_remaining <= 2 || data.storage_usage_percent > 80) {
                alertDiv.classList.add('alert-warning');
            } else {
                alertDiv.classList.add('alert-info');
            }
        }
    })
    .catch(error => {
        console.error('Error loading quota status:', error);
        document.getElementById('quotaStatus').textContent = 'Unable to load quota information';
    });
}

function loadInvestigations() {
    fetch('/api/investigations')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        const select = document.getElementById('investigationSelect');
        if (!select) {
            console.error('investigationSelect element not found');
            return;
        }
        
        select.innerHTML = '<option value="">No investigation</option>';
        
        // API returns array directly, not wrapped in investigations property
        if (Array.isArray(data) && data.length > 0) {
            data.forEach(investigation => {
                const option = document.createElement('option');
                option.value = investigation.id;
                option.textContent = investigation.name;
                select.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error loading investigations:', error);
    });
}

function checkActiveDownloads() {
    fetch('/api/video-downloader/downloads')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.downloads) {
            const active = data.downloads.filter(d => 
                ['pending', 'analyzing', 'queued', 'downloading'].includes(d.status)
            );
            
            if (active.length > 0) {
                showAnalyzeNext();
                activeDownloads = active.map(d => d.download_id);
            }
        }
    })
    .catch(error => {
        console.error('Error checking active downloads:', error);
    });
}

function showAnalyzeNext() {
    document.getElementById('analyzeNext').style.display = 'block';
}

function hideAnalyzeNext() {
    document.getElementById('analyzeNext').style.display = 'none';
}

function analyzeNextVideo(event) {
    event.preventDefault();
    
    const url = document.getElementById('nextVideoUrl').value;
    if (!url) {
        showError('Please enter a video URL');
        return;
    }
    
    // Clear the form
    document.getElementById('nextVideoUrl').value = '';
    
    // Set the URL in the main form and trigger analysis
    document.getElementById('videoUrl').value = url;
    document.getElementById('analyzeForm').dispatchEvent(new Event('submit'));
    
    // Scroll to analysis section
    document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').style.display = 'block';
    document.getElementById('errorAlert').scrollIntoView({ behavior: 'smooth' });
}

function showSuccess(message) {
    // Create success alert if it doesn't exist
    let successAlert = document.getElementById('successAlert');
    if (!successAlert) {
        successAlert = document.createElement('div');
        successAlert.id = 'successAlert';
        successAlert.className = 'alert alert-success';
        successAlert.style.display = 'none';
        successAlert.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-check-circle"></i>
                    <strong>Success:</strong> <span id="successMessage"></span>
                </div>
                <button type="button" class="btn-close" onclick="hideSuccess()"></button>
            </div>
        `;
        document.getElementById('errorAlert').parentNode.insertBefore(successAlert, document.getElementById('errorAlert'));
    }
    
    document.getElementById('successMessage').textContent = message;
    successAlert.style.display = 'block';
    successAlert.scrollIntoView({ behavior: 'smooth' });
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        hideSuccess();
    }, 5000);
}

function hideSuccess() {
    const successAlert = document.getElementById('successAlert');
    if (successAlert) {
        successAlert.style.display = 'none';
    }
}

function hideError() {
    document.getElementById('errorAlert').style.display = 'none';
}

// Utility functions
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

function formatDuration(seconds) {
    if (!seconds) return 'Unknown';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

function formatFileSize(bytes) {
    if (!bytes) return 'Unknown';
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    try {
        return new Date(dateString).toLocaleString();
    } catch {
        return dateString;
    }
}

function formatNumber(num) {
    if (!num) return '0';
    return num.toLocaleString();
}

function loadTorStatus() {
    fetch('/api/tor/status')
    .then(response => response.json())
    .then(data => {
        const torStatusDiv = document.getElementById('torStatus');
        const torCheckbox = document.getElementById('useTorProxy');
        
        if (data.enabled && data.running) {
            torStatusDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">
                        <i class="bi bi-check-circle"></i> TOR Active
                    </span>
                    <small class="text-muted">Current IP: ${data.current_ip || 'Unknown'}</small>
                </div>
            `;
            torCheckbox.disabled = false;
        } else if (data.enabled && !data.running) {
            torStatusDiv.innerHTML = `
                <span class="badge bg-warning">
                    <i class="bi bi-exclamation-triangle"></i> TOR Not Running
                </span>
            `;
            torCheckbox.disabled = true;
            torCheckbox.checked = false;
        } else {
            torStatusDiv.innerHTML = `
                <span class="badge bg-secondary">
                    <i class="bi bi-x-circle"></i> TOR Disabled
                </span>
            `;
            torCheckbox.disabled = true;
            torCheckbox.checked = false;
        }
    })
    .catch(error => {
        console.error('Error loading TOR status:', error);
        document.getElementById('torStatus').innerHTML = `
            <span class="badge bg-danger">
                <i class="bi bi-exclamation-triangle"></i> TOR Status Unknown
            </span>
        `;
        document.getElementById('useTorProxy').disabled = true;
    });
}
</script>

<style>
.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

.card-header.bg-success {
    border-color: #198754;
}
</style>

{% endblock %}